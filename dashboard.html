<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Motor Monitor Pro</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --danger: #e74c3c; --success: #27ae60; --bg: #ecf0f1; --input-bg: #fff; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: var(--bg); color: #333; max-width: 900px; margin: auto; }
        
        h2 { color: var(--primary); border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        h3 { color: var(--primary); margin-top: 0; }
        
        /* Kartu Sensor */
        .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card {
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; border-top: 4px solid var(--accent);
        }
        .card h3 { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; }
        .card p { font-size: 2rem; font-weight: 700; margin: 0; color: var(--primary); }
        .unit { font-size: 1rem; color: #95a5a6; font-weight: normal; }

        /* Panel Kontrol Input (Simulasi) */
        .control-panel {
            background: white; padding: 20px; border-radius: 8px; margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 6px solid #8e44ad; /* Ungu */
        }
        .input-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .input-item label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 5px; font-weight: 600; }
        .input-item input {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 1rem; box-sizing: border-box;
        }
        .btn-submit {
            background: #8e44ad; color: white; border: none; padding: 12px 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px;
            transition: 0.2s;
        }
        .btn-submit:hover { background: #732d91; }

        /* Status Box */
        #statusBox { 
            padding: 20px; background: white; border-left: 6px solid var(--accent);
            border-radius: 6px; margin-bottom: 25px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: space-between;
        }
        #statusText { font-size: 1.4rem; font-weight: bold; margin: 0; }
        .status-label { font-size: 0.9rem; color: #7f8c8d; display: block; margin-bottom: 5px; }

        /* Tabel & Tombol */
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        button#clearBtn {
            background: var(--danger); color: white; border: none; padding: 8px 16px; 
            border-radius: 4px; cursor: pointer; transition: 0.2s; font-weight: bold;
        }
        button#clearBtn:hover { background: #c0392b; }
        
        .table-wrapper { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        
        th:first-child, td:first-child { width: 50px; text-align: center; color: #7f8c8d; }
        .time-badge { background: #e8f6f3; color: #16a085; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }

        /* About Section */
        .about-section {
            margin-top: 40px; padding: 30px; background: #fff; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--primary);
        }
        .about-steps { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; }
        .step { background: #f8f9fa; padding: 15px; border-radius: 6px; border: 1px solid #e9ecef; }
        .step h4 { color: var(--accent); margin-top: 0; margin-bottom: 10px; }
        .step p { font-size: 0.9rem; color: #666; line-height: 1.5; margin: 0; }
        
        @media (max-width: 700px) { .about-steps { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <h2>Dashboard Monitoring Realtime</h2>

    <div class="card-container">
        <div class="card">
            <h3>Mesin (Suhu)</h3>
            <p id="suhu">- <span class="unit">¬∞C</span></p>
        </div>
        <div class="card">
            <h3>Aki (Tegangan)</h3>
            <p id="tegangan">- <span class="unit">V</span></p>
        </div>
        <div class="card">
            <h3>Putaran (RPM)</h3>
            <p id="rpm">-</p>
        </div>
        <div class="card">
            <h3>Kecepatan</h3>
            <p id="kecepatan">- <span class="unit">km/h</span></p>
        </div>
    </div>

    <div class="control-panel">
        <h3>üéõÔ∏è Simulasi Sensor (Input Manual)</h3>
        <form id="sensorForm" onsubmit="sendData(event)">
            <div class="input-group">
                <div class="input-item">
                    <label>Suhu (¬∞C)</label>
                    <input type="number" id="inSuhu" step="0.1" placeholder="cth: 85.5" required>
                </div>
                <div class="input-item">
                    <label>Tegangan (V)</label>
                    <input type="number" id="inTegangan" step="0.1" placeholder="cth: 12.1" required>
                </div>
                <div class="input-item">
                    <label>RPM</label>
                    <input type="number" id="inRPM" placeholder="cth: 4000" required>
                </div>
                <div class="input-item">
                    <label>Kecepatan (km/h)</label>
                    <input type="number" id="inSpeed" placeholder="cth: 60" required>
                </div>
            </div>
            <button type="submit" class="btn-submit">üì° Kirim Data ke Server</button>
        </form>
    </div>

    <div id="statusBox">
        <div>
            <span class="status-label">Diagnosa Kondisi Saat Ini:</span>
            <p id="statusText">Menunggu data...</p>
        </div>
    </div>

    <div class="history-header">
        <h3>Log Data Masuk</h3>
        <button id="clearBtn" onclick="clearHistory()">üóë Reset Log</button>
    </div>
    
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Waktu (Realtime)</th>
                    <th>Suhu (¬∞C)</th>
                    <th>Tegangan (V)</th>
                    <th>RPM</th>
                    <th>Kecepatan</th>
                </tr>
            </thead>
            <tbody id="historyTable"></tbody>
        </table>
    </div>

    <div class="about-section">
        <h3>‚ÑπÔ∏è Cara Kerja Sistem</h3>
        <p>Sistem ini adalah solusi pemantauan kendaraan berbasis IoT yang mengintegrasikan pengambilan data fisik dengan pengolahan digital secara <em>real-time</em>.</p>
        
        <div class="about-steps">
            <div class="step">
                <h4>1. Input Data</h4>
                <p>Anda bisa menggunakan <strong>Panel Simulasi</strong> di atas untuk memasukkan data Suhu, Tegangan, dll secara manual, seolah-olah data tersebut dikirim oleh sensor.</p>
            </div>
            <div class="step">
                <h4>2. Proses (Backend)</h4>
                <p>Server Go menerima data, lalu memberikan <strong>ID Unik</strong> dan <strong>Stempel Waktu</strong>. Server juga menjalankan fungsi diagnosa otomatis untuk mengecek anomali (misal: Overheat).</p>
            </div>
            <div class="step">
                <h4>3. Visualisasi</h4>
                <p>Dashboard ini menarik data terbaru setiap 2 detik. Hasilnya ditampilkan pada Kartu Status (atas) dan Log Riwayat (bawah) secara Realtime.</p>
            </div>
        </div>

        <p style="margin-top: 20px; font-size: 0.9rem; color: #888;">
            *Backend dibangun dengan prinsip <strong>Functional Programming</strong> untuk logika status yang modular dan aman.
        </p>
    </div>

    <script>
        // 1. Fungsi Mengirim Data
        async function sendData(e) {
            e.preventDefault(); 
            
            const payload = {
                suhu: parseFloat(document.getElementById("inSuhu").value),
                tegangan: parseFloat(document.getElementById("inTegangan").value),
                rpm: parseInt(document.getElementById("inRPM").value),
                kecepatan: parseInt(document.getElementById("inSpeed").value)
            };

            try {
                const response = await fetch("/api/sensor", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    fetchData();
                } else {
                    alert("Gagal mengirim data.");
                }
            } catch (err) {
                console.error(err);
                alert("Error koneksi ke backend.");
            }
        }

        // 2. Fungsi Fetch Data (Monitoring)
        async function fetchData() {
            try {
                const [sensorRes, statusRes, historyRes] = await Promise.all([
                    fetch("/api/sensor"),
                    fetch("/api/sensor/status"),
                    fetch("/api/sensor/history")
                ]);

                const sensor = await sensorRes.json();
                const status = await statusRes.json();
                const history = await historyRes.json();

                // Update Kartu
                document.getElementById("suhu").innerHTML = (sensor.suhu || 0) + ' <span class="unit">¬∞C</span>';
                document.getElementById("tegangan").innerHTML = (sensor.tegangan || 0) + ' <span class="unit">V</span>';
                document.getElementById("rpm").innerText = sensor.rpm || 0;
                document.getElementById("kecepatan").innerHTML = (sensor.kecepatan || 0) + ' <span class="unit">km/h</span>';

                // Update Status
                const statusEl = document.getElementById("statusText");
                const boxEl = document.getElementById("statusBox");
                
                statusEl.innerText = status.status;
                if (status.status === "Sistem Normal") {
                    boxEl.style.borderLeftColor = "#27ae60"; 
                    statusEl.style.color = "#27ae60";
                } else {
                    boxEl.style.borderLeftColor = "#c0392b";
                    statusEl.style.color = "#c0392b";
                }

                // Update Tabel
                let tableHTML = "";
                if (history && history.length > 0) {
                    history.slice().reverse().slice(0, 10).forEach(h => {
                        tableHTML += `<tr>
                            <td>#${h.id}</td>
                            <td><span class="time-badge">${h.waktu}</span></td>
                            <td>${h.suhu}</td>
                            <td>${h.tegangan}</td>
                            <td>${h.rpm}</td>
                            <td>${h.kecepatan}</td>
                        </tr>`;
                    });
                } else {
                    tableHTML = `<tr><td colspan="6" style="text-align:center; color:#999; padding:20px;">Belum ada data masuk.</td></tr>`;
                }
                document.getElementById("historyTable").innerHTML = tableHTML;

            } catch (err) {
                console.error(err);
                document.getElementById("statusText").innerText = "Koneksi Terputus...";
                document.getElementById("statusText").style.color = "#95a5a6";
            }
        }

        async function clearHistory() {
            if(!confirm("Hapus semua log data? ID akan di-reset.")) return;
            try {
                await fetch("/api/sensor/history", { method: "DELETE" });
                fetchData();
            } catch (e) { alert("Gagal reset data"); }
        }

        setInterval(fetchData, 2000);
        fetchData();
    </script>
</body>
</html>